name: Destroy Preview Stack (Pulumi)

on:
  delete:

permissions:
  contents: read

jobs:
  destroy:
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Compute stack name from deleted branch
        id: stack
        shell: bash
        run: |
          set -euo pipefail

          ref_name="${{ github.event.ref }}"

          if [[ "$ref_name" =~ ^([0-9]+)-.*$ ]]; then
            stack="staging-${BASH_REMATCH[1]}"
          else
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # never destroy these
          if [[ "$stack" == "staging-main" || "$stack" == "production" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "stack=$stack" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-python@v5
        if: steps.stack.outputs.skip != 'true'
        with:
          python-version: "3.12"

      - name: Install infra deps
        if: steps.stack.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r infra/requirements.txt

      - name: Write kubeconfig
        if: steps.stack.outputs.skip != 'true'
        run: |
          mkdir -p "$HOME/.kube"
          printf "%s" "${KUBECONFIG_CONTENT}" > "$HOME/.kube/config"
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}

      - name: Install Pulumi CLI
        if: steps.stack.outputs.skip != 'true'
        uses: pulumi/actions@v6
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Destroy stack resources
        if: steps.stack.outputs.skip != 'true'
        uses: pulumi/actions@v6
        with:
          command: destroy
          work-dir: infra
          stack-name: ${{ vars.PULUMI_ORG }}/${{ steps.stack.outputs.stack }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_TOKEN: ${{ secrets.GH_ADMIN_TOKEN }}

      - name: Remove stack state
        if: steps.stack.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          pulumi login
          pulumi -C infra stack rm --yes "${PULUMI_ORG}/${STACK}"
        env:
          PULUMI_ORG: ${{ vars.PULUMI_ORG }}
          STACK: ${{ steps.stack.outputs.stack }}
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
