name: Destroy Preview Stack (Pulumi)

on:
  delete:
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  destroy:
    if: github.event.ref_type == 'branch' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Compute stack name from deleted branch
        id: stack
        shell: bash
        run: |
          set -euo pipefail

          ref_name="${{ github.event.ref }}"

          if [[ "$ref_name" =~ ^([0-9]+)-.*$ ]]; then
            stack="staging-${BASH_REMATCH[1]}"
            case_id="${BASH_REMATCH[1]}"
          else
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # never destroy these
          if [[ "$stack" == "staging-main" || "$stack" == "production" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "case_id=$case_id" >> "$GITHUB_OUTPUT"
          echo "stack=$stack" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-python@v5
        if: steps.stack.outputs.skip != 'true'
        with:
          python-version: "3.12"

      - name: Install infra deps
        if: steps.stack.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r infra/requirements.txt

      - name: Write kubeconfig
        if: steps.stack.outputs.skip != 'true'
        run: |
          mkdir -p "$HOME/.kube"
          printf "%s" "${KUBECONFIG_CONTENT}" > "$HOME/.kube/config"
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}

      - uses: pulumi/auth-actions@v1
        if: steps.stack.outputs.skip != 'true'
        with:
          organization: ${{ vars.PULUMI_ORG }}
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:steve-todorov

      - name: "[pulumi] environment setup"
        if: steps.stack.outputs.skip != 'true'
        shell: bash
        env:
          STACK: ${{ steps.stack.outputs.stack }}
          ORG: ${{ vars.PULUMI_ORG }}
          PROJECT: ${{ vars.PULUMI_PROJECT }}
        run: |
          cat > "infra/Pulumi.${STACK}.yaml" <<EOF
          environment:
            - ${PROJECT}/common
          config:
            case_id: "${{ steps.stack.outputs.case_id }}"
          EOF
          cat infra/Pulumi.${STACK}.yaml

      - name: "[pulumi] Destroy stack resources"
        if: steps.stack.outputs.skip != 'true'
        uses: pulumi/actions@v6
        with:
          command: destroy
          work-dir: infra
          stack-name: ${{ vars.PULUMI_ORG }}/${{ vars.PULUMI_PROJECT }}/${{ steps.stack.outputs.stack }}
          comment-on-summary: true
        env:
          GITHUB_OWNER: ${{ github.repository_owner }}

      - name: Remove stack state
        if: steps.stack.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          pulumi -C infra stack rm --yes "${ORG}/${STACK}"
        env:
          ORG: ${{ vars.PULUMI_ORG }}
          STACK: ${{ steps.stack.outputs.stack }}
