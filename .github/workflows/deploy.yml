name: Deploy (Pulumi)

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Compute stack name
        id: stack
        shell: bash
        run: |
          set -euo pipefail

          ref_name="${GITHUB_REF_NAME}"
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            ref_name="${GITHUB_HEAD_REF}"
          fi

          if [[ "$ref_name" == "main" ]]; then
            stack="staging-main"
            case_id="staging-main"
          elif [[ "$ref_name" == "production" ]]; then
            stack="production"
            case_id="production"
          elif [[ "$ref_name" =~ ^([0-9]+)-.*$ ]]; then
            stack="staging-${BASH_REMATCH[1]}"
            case_id="${BASH_REMATCH[1]}"
          else
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "case_id=$case_id" >> "$GITHUB_OUTPUT"
          echo "stack=$stack" >> "$GITHUB_OUTPUT"
          echo "environment=$stack" >> "$GITHUB_OUTPUT"

      - uses: actions/setup-python@v5
        if: steps.stack.outputs.skip != 'true'
        with:
          python-version: "3.12"

      - name: Install infra deps
        if: steps.stack.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r infra/requirements.txt

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - name: Log into registry ${{ env.REGISTRY }}
        if: steps.stack.outputs.skip != 'true'
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (tag = ENVIRONMENT)
        if: steps.stack.outputs.skip != 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:${{ steps.stack.outputs.environment }}

      - name: Write kubeconfig
        if: steps.stack.outputs.skip != 'true'
        run: |
          mkdir -p "$HOME/.kube"
          printf "%s" "${KUBECONFIG_CONTENT}" > "$HOME/.kube/config"
        env:
          KUBECONFIG_CONTENT: ${{ secrets.KUBECONFIG }}

      - uses: pulumi/auth-actions@v1
        if: steps.stack.outputs.skip != 'true'
        with:
          organization: ${{ vars.PULUMI_ORG }}
          requested-token-type: urn:pulumi:token-type:access_token:personal
          scope: user:steve-todorov

      - name: "[pulumi] environment setup"
        if: steps.stack.outputs.skip != 'true'
        shell: bash
        env:
          STACK: ${{ steps.stack.outputs.stack }}
          ORG: ${{ vars.PULUMI_ORG }}
          PROJECT: ${{ vars.PULUMI_PROJECT }}
        run: |
          cat > "infra/Pulumi.${STACK}.yaml" <<EOF
          environment:
            - ${PROJECT}/common
          config:
            case_id: "${{ steps.stack.outputs.case_id }}"
          EOF
          cat infra/Pulumi.${STACK}.yaml

      - name: "[pulumi] preview"
        uses: pulumi/actions@v6
        if: steps.stack.outputs.skip != 'true'
        env:
          # pulumi-github provider auth
          GITHUB_OWNER: ${{ github.repository_owner }}
        with:
          command: preview
          work-dir: infra
          stack-name: ${{ vars.PULUMI_ORG }}/${{ vars.PULUMI_PROJECT }}/${{ steps.stack.outputs.stack }}
          upsert: true
          diff: true
          comment-on-summary: true

      - name: "[pulumi] up"
        uses: pulumi/actions@v6
        if: steps.stack.outputs.skip != 'true'
        env:
          # pulumi-github provider auth
          GITHUB_OWNER: ${{ github.repository_owner }}
        with:
          command: up
          work-dir: infra
          stack-name: ${{ vars.PULUMI_ORG }}/${{ vars.PULUMI_PROJECT }}/${{ steps.stack.outputs.stack }}
          upsert: true
          comment-on-summary: true
          always-include-summary: "true"
